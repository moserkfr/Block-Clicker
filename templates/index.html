{% extends "layout.html" %}

{% block title %}Block Clicker{% endblock %}

{% block main %}
    <div class="left">
        <p>
            <h3 class="displayname">{{ user["username"] }}'s Mine</h3>
            <p class="counter">
                <span id="counter" data-bps="{{ user['bps'] }}">{{ user["blocks"] }}</span> blocks
            </p>
            <p class="ps">per second: <span id="bps-display">{{ user["bps"] }}</span></p>
            <button class="clicker" id="clicker" onclick="incrementBlocks()">
                <img src="{{ url_for('static', filename='images/stone.png') }}" alt="Stone" class="clicker-image pop">
            </button>
        </p>
    </div>
    <div class="right">
        <h2 class="displayname">Upgrades</h2>
        <div class="upgrade-list">
            <p>
                ‚õèÔ∏èPickaxe (Level <span id="pickaxe-level">{{ upgrades["pickaxe"]["level"] }}</span>)<br>
                Cost: <span id="pickaxe-cost">{{ upgrades["pickaxe"]["cost"] }}</span> blocks
            </p>
            <form onsubmit="buyUpgrade('pickaxe'); return false;">
                <button type="submit">Buy</button>
            </form>
        
            <p>
                üßç‚Äç‚ôÇÔ∏èFriend (Level <span id="friend-level">{{ upgrades["friend"]["level"] }}</span>)<br>
                Cost: <span id="friend-cost">{{ upgrades["friend"]["cost"] }}</span> blocks
            </p>
            <form onsubmit="buyUpgrade('friend'); return false;">
                <button type="submit">Buy</button>
            </form>

            <p>
                üåüBeacon (Level <span id="beacon-level">{{ upgrades["beacon"]["level"] }}</span>)<br>
                Cost: <span id="beacon-cost">{{ upgrades["beacon"]["cost"] }}</span> blocks
            </p>
            <form onsubmit="buyUpgrade('beacon'); return false;">
                <button type="submit">Buy</button>
            </form>
        </div>
    </div>

    
    <script>
        async function autoMine() {
            const counter = document.getElementById('counter');
            
            const currentBps = parseInt(counter.getAttribute('data-bps')); 

            if (currentBps > 0) {
                const response = await fetch('/auto_mine', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                });
                
                if (response.ok) {
                    const data = await response.json();
                    counter.innerText = data.blocks;
                }
            }
        }

        setInterval(autoMine, 1000); 

        async function buyUpgrade(upgradeType) {
            const response = await fetch(`/upgrade`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ upgrade_type: upgradeType })
            });
            
            const data = await response.json();
            
            if (data.error) {
                alert(data.error);
            } else {
                const counter = document.getElementById('counter');
                const bpsDisplay = document.getElementById('bps-display');

                counter.innerText = data.blocks;

                if (bpsDisplay) {
                    bpsDisplay.innerText = data.bps;
                }
                counter.setAttribute('data-bps', data.bps);

                const type = data.upgrade_type;
                
                if (document.getElementById(type + '-cost')) {
                    document.getElementById(type + '-cost').innerText = data.next_cost;
                }
                if (document.getElementById(type + '-level')) {
                    document.getElementById(type + '-level').innerText = data.level;
                }
            }
        }
    </script>

{% endblock %}